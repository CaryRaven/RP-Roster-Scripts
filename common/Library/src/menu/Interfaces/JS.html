<script>
  document.addEventListener("DOMContentLoaded", function () {
    /* ******** UTILITIES *******************************************************/

    // Set general colors based on hex from library settings
    const hex = document.getElementById("hex").innerText;
    document.body.style.backgroundColor = hex;

    ["sidebar", "main-content"].forEach(name => {
      const classElements = document.getElementsByClassName(name);

      for (let m = 0; m < classElements.length; m++) {
        classElements[m].style.backgroundColor = hex;
      }
    });

    ["req", "task"].forEach(name => {
      const classElements = document.getElementsByClassName(name);

      for (let m = 0; m < classElements.length; m++) {
        classElements[m].style.borderLeft = `8px solid ${hex}`;
      }
    });

    window.CloseChangelog =  function (event) {
      try { event.preventDefault(); } catch(e) { }
      document.getElementById("update-popup").setAttribute("style", "display: none;");
      document.getElementById("changeLoader").setAttribute("style", "display: none;");
      document.getElementById("admin-menu").setAttribute("style", "display: block;");
    }

    window.Shake = function () {
      document.body.classList.add('shake');
      setTimeout(() => document.body.classList.remove('shake'), 200);
    };

    window.SetSpecSelects = function () {
      google.script.run.withSuccessHandler(specs => {
        const specField = document.getElementById("specfield").value;
        document.getElementById("removeSpec").innerHTML = "";
        const editSpec = document.getElementById("editSpecSelect").value;

        if (editSpec === "") document.getElementById("editSpecSelect").innerHTML = "";
        if (specField === "") document.getElementById("specfield").innerHTML = "";
        specs = JSON.parse(specs);

        specs.forEach(spec => {
          if (specField === "") {
            const specOption = document.createElement("option");
            specOption.innerText = spec.title;
            document.getElementById("specfield").appendChild(specOption);
          }

          const specOptionConfig = document.createElement("option");
          specOptionConfig.innerText = spec.title;
          document.getElementById("removeSpec").appendChild(specOptionConfig);

          if (editSpec === "") {  
            const specOptionConfig2 = document.createElement("option");
            specOptionConfig2.innerText = spec.title;
            document.getElementById("editSpecSelect").appendChild(specOptionConfig2);
          }
        });
      }).ReturnSpecs();
    };

    // Set the selects for emails
    window.SetEmailSelects = function () {
      google.script.run.withSuccessHandler(emails => {
        if (emails.length <= 0) return console.error("No emails were found on any roster.");
        emails = JSON.parse(emails);

        ["emailfield", "curremailfield"].forEach(id => {

          const select = document.getElementById(id);
          select.innerHTML = "<option value=''></option>";
          emails.forEach(email => {
            const option = document.createElement("option");
            option.value = email.toString();
            option.innerText = email.toString();
            select.appendChild(option);
          });
        });
      }).GetAllEmails();
    }

    SetEmailSelects();

    // Make the lockdown button shimmer (idk looks cool)
    document.getElementById('lockdownButton').classList.add("light");

    // Get admin ranks
    const adminRanks = document.getElementById("adminRanks").innerText;
    document.getElementById("adminRanks").innerText = "";

    window.SetRankSelects = function(forced = false) {
      let initRanks = document.getElementById("ranks")?.innerText;
      let groups = document.getElementById("groups")?.innerText;
      let rankSelect = document.getElementById("mod-role-select");
      let managerRankSelect = document.getElementById("manager-role-select");
      let rankRowSelect = document.getElementById("new-rank-select");
      let addRankSelect = document.getElementById("new-rank-before-select");
      let groupSelect = document.getElementById("new-rank-group-select");
      let removeRankSelect = document.getElementById("remove-rank-select");
      const editRankSelect = document.getElementById("editRankSelect");

      if (initRanks) {
        initRanks = initRanks.split(",");
      } else {
        initRanks = [];
      }

      if (groups) {
        groups = groups.split(",");
        groups = groups.filter(onlyUnique);
      } else {
        groups = [];
      }

      if (rankSelect.value === "" || forced === true) rankSelect.innerHTML = '<option value=""></option>';
      if (managerRankSelect.value === "" || forced === true) managerRankSelect.innerHTML = '<option value=""></option>';
      if (rankRowSelect.value === "" || forced === true) rankRowSelect.innerHTML = '<option value=""></option>';
      if (removeRankSelect.value === "" || forced === true) removeRankSelect.innerHTML = '<option value=""></option>';
      if (addRankSelect.value === "" || forced === true) addRankSelect.innerHTML = '<option value=""></option>';
      if (editRankSelect.value === "" || forced === true) editRankSelect.innerHTML = '<option value=""></option>';
      if (groupSelect.value === "" || forced === true) groupSelect.innerHTML = '<option value=""></option>';

      initRanks.forEach(rankName => {
        
        // TODO: fix this statement
        if (!adminRanks.includes(rankName)) {

          if (rankSelect.value === "" || forced === true) {
            const rankOption = document.createElement("option");
            rankOption.value = rankName;
            rankOption.innerText = rankName;
            rankSelect.appendChild(rankOption); 
          }

          if (managerRankSelect.value === "" || forced === true) {
            const rankOption = document.createElement("option");
            rankOption.value = rankName;
            rankOption.innerText = rankName;
            managerRankSelect.appendChild(rankOption); 
          }

          if (rankRowSelect.value === "" || forced === true) {
            const rankRowOption = document.createElement("option");
            rankRowOption.value = rankName;
            rankRowOption.innerText = rankName;
            rankRowSelect.appendChild(rankRowOption);
          }

          if (addRankSelect.value === "" || forced === true) {
            const addRankOption = document.createElement("option");
            addRankOption.value = rankName;
            addRankOption.innerText = rankName;
            addRankSelect.appendChild(addRankOption);
          }

          if (editRankSelect.value == "" || forced === true) {
            const editRankOption = document.createElement("option");
            editRankOption.value = rankName;
            editRankOption.innerText = rankName;
            editRankSelect.appendChild(editRankOption);
          }

          if (removeRankSelect.value === "" || forced === true) {
            const removeRankOption = document.createElement("option");
            removeRankOption.value = rankName;
            removeRankOption.innerText = rankName;
            removeRankSelect.appendChild(removeRankOption);
          }
        }
      });

      groups.forEach(group => {
        if ((groupSelect.value === "" || forced === true) && group !== "Sr CL4") {
          const groupOption = document.createElement("option");
          groupOption.value = group;
          groupOption.innerText = group;
          groupSelect.appendChild(groupOption);
        }
      });
    };

    window.onlyUnique = function(value, index, array) {
      return array.indexOf(value) === index;
    };

    let configupdate;

    window.SetSliders = function() {
      google.script.run.withSuccessHandler(r => {
        r = JSON.parse(r);
        document.getElementById('manualEditingSlider').checked = !(r[0] === "true");
        document.getElementById('pingSlider').checked = (r[1] === "true");
        document.getElementById('backupSlider').checked = (r[2] === "true");
        if (r[3] === "true") {
          document.getElementById('lockdown-topbanner').style.display = "block";
          document.getElementById('lockdownIdentifier').innerText = "Disable";
        } else {
          document.getElementById('lockdown-topbanner').style.display = "none";
          document.getElementById('lockdownIdentifier').innerText = "Enable";
        }
      }).ReturnSliders();
    };

    // Set the changelog data if applicable
    let viewChange = document.getElementById("viewChange");
    let changeLogList = document.getElementById("changeLogList");
    if (viewChange.innerText == "false") {
      CloseChangelog();
    } else {
      google.script.run.withSuccessHandler(property => {
        property = JSON.parse(property);
        const notes = property.fields;

        notes.forEach(note => {
          const noteLi = document.createElement("li");
          noteLi.innerText = note;
          changeLogList.appendChild(noteLi);
        });
        document.getElementById("update-popup").setAttribute("style", "display: block;");
        document.getElementById("changeLoader").setAttribute("style", "display: none;");
      }).withFailureHandler(() => {
        document.getElementById("update-popup").setAttribute("style", "display: block;");
        document.getElementById("changeLoader").setAttribute("style", "display: none;");
        changeLogList.innerHTML = "<li>Something went wrong while loading the changelogs</li>"
      }).GetChangeNotes();
    }

    // Function to handle people going AFK (since there is a limit of 30 active members on web apps)
    let afkTimer = window.setTimeout(() => {
      document.getElementById("afkBanner").style.display = "";
    }, 300000);

    document.addEventListener("click", () => {
      window.clearTimeout(afkTimer);
      document.getElementById("afkBanner").style.display = "none";
      afkTimer = window.setTimeout(() => {
        document.getElementById("afkBanner").style.display = "";
      }, 300000);
    });

    /*
    **************************************************************************************************
      Function responsible for handling the sidebar functionality
      When adding a new tab, make sure you update these functions to show/hide the new panel too
    */

    window.StartConfigInterval = function () {
      try { clearInterval(configupdate) } catch(e) { }

      SetSpecSelects();
      SetRankSelects(true);
      SetSliders();
      configupdate = setInterval(() => {
        SetSpecSelects();
        SetRankSelects();
        SetSliders();
      }, 10000);
    }

    window.ShowDash = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: block;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: none;');
      // document.getElementById('connections').setAttribute('style', 'display: none;');
      document.getElementById('search_panel').setAttribute('style', 'display: none;');
      document.getElementById("requests-panel").setAttribute("style", "display: none;");
      SetEmailSelects();
      try {
        document.getElementById('config').setAttribute('style', 'display: none;'); 
        clearInterval(configupdate);
        SetRankSelects(true);
        setInterval(() => {
          SetRankSelects();
        }, 10000);
      } catch (e) {  }
    }

    window.ShowManual = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: block;');
      // document.getElementById('connections').setAttribute('style', 'display: none;');
      document.getElementById('search_panel').setAttribute('style', 'display: none;');
      document.getElementById("requests-panel").setAttribute("style", "display: none;");
      try { 
        document.getElementById('config').setAttribute('style', 'display: none;'); 
        clearInterval(configupdate);
      } catch (e) {  }
    }

    window.ShowConnections = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: none;');
      // document.getElementById('connections').setAttribute('style', 'display: block;');
      document.getElementById('search_panel').setAttribute('style', 'display: none;');
      document.getElementById("requests-panel").setAttribute("style", "display: none;");
      try { 
        document.getElementById('config').setAttribute('style', 'display: none;'); 
        clearInterval(configupdate);
      } catch (e) {  }
    }

    window.ShowSearch = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: none;');
      // document.getElementById('connections').setAttribute('style', 'display: none;');
      document.getElementById('search_panel').setAttribute('style', 'display: block;');
      document.getElementById("searchLoading").setAttribute("style", "display: none;");
      document.getElementById("requests-panel").setAttribute("style", "display: none;");
      try { 
        document.getElementById('config').setAttribute('style', 'display: none;'); 
        clearInterval(configupdate);
      } catch (e) {  }
    }

    window.ShowConfig = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: none;');
      // document.getElementById('connections').setAttribute('style', 'display: none;');
      document.getElementById('search_panel').setAttribute('style', 'display: none;');
      document.getElementById('config').setAttribute('style', 'display: block;');
      document.getElementById("requests-panel").setAttribute("style", "display: none;");
      StartConfigInterval();
    }

    window.ShowRequests = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('data-forms').setAttribute('style', 'display: none;');
      document.getElementById('usermanual').setAttribute('style', 'display: none;');
      // document.getElementById('connections').setAttribute('style', 'display: none;');
      document.getElementById('search_panel').setAttribute('style', 'display: none;');
      document.getElementById("searchLoading").setAttribute("style", "display: none;");
      document.getElementById("requests-panel").setAttribute("style", "display: block;");
      try { 
        document.getElementById('config').setAttribute('style', 'display: none;'); 
        clearInterval(configupdate);
        FillRequests();
      } catch (e) {  }
    }
    /* ************************************************************************************************* */

    // Managing form (dashboard visibility)
    window.OpenLogForm = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('loggerForm').setAttribute('style', 'display: flex;');
      document.getElementById('data-forms').setAttribute('style', 'display: block;');
      document.getElementById('editForm').setAttribute('style', 'display: none;');
    }

    window.OpenEditForm = function () {
      document.getElementById('dashboard').setAttribute('style', 'display: none;');
      document.getElementById('editForm').setAttribute('style', 'display: block;');
      document.getElementById('data-forms').setAttribute('style', 'display: block;');
      document.getElementById('loggerForm').setAttribute('style', 'display: none;');
    }

    // Show the slider option to toggle the terminal animation on open
    google.script.run.withSuccessHandler((response) => {
      document.getElementById("showTerminalSlider").checked = (response === "true");
      document.getElementById("terminalConfig").style.display = "block";
    }).ReturnTerminalSetting();
    try {
      document.getElementById('showTerminalSlider').addEventListener('change', function () {
        google.script.run.withSuccessHandler((response) => {
          document.getElementById("showTerminalSlider").checked = (response === "true");
        }).ToggleTerminal(this.checked);
      });
    } catch(e) {
      console.log("Terminal failed");
    }

    // SEARCH HANDLERS ********************************************************************************
    window.UpdateDiv = function (event) {
      event.preventDefault();
      const inputValue = document.getElementById('inputField').value;
      if (inputValue === "" || !inputValue.length === 5) {
        Shake();
        return;
      }

      document.getElementById("loading-search").innerText = "Searching for matching data...";
      document.getElementById("searchLoading").setAttribute("style", "display: block;")

      google.script.run
        .withSuccessHandler(DisplayData)
        .withFailureHandler(error => {
          console.error("Server error:", error); // Log server-side errors
          
          document.getElementById("loading-search").innerText = "An error occured when trying to fetch the data: " + error;
          document.getElementById("searchLoading").setAttribute("style", "display: none;");
        }).GetSpreadsheetData(inputValue);
    }

    window.DisplayData = function (data) {
      data = JSON.parse(data);

      const outputDiv = document.getElementById('outputDiv');
      outputDiv.innerHTML = '';

      if (!data || data.length === 0) {
        document.getElementById("loading-search").innerText = "No matching data was found, please try another Player ID.";
        document.getElementById("searchLoading").setAttribute("style", "display: none;");
        return;
      }

      // Format dates to be readable => made using AI (I couldn't be asked)
      function FormatDate(dateString) {
        const date = new Date(dateString);
        if (isNaN(date)) return dateString; // Return original string if not a valid date
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      const cardContainer = document.createElement('div');
      cardContainer.style.display = "flex";
      cardContainer.style.flexWrap = "wrap";
      cardContainer.style.justifyContent = "center";
      cardContainer.style.gap = "15px";
      cardContainer.style.backgroundColor = "#777777";
      cardContainer.style.marginTop = "20px";
      cardContainer.style.padding = "20px";
      cardContainer.style.borderRadius = "10px";

      data.forEach(item => {
        const card = document.createElement('div');
        card.style.border = "4px solid black";
        card.style.borderRadius = "10px";
        card.style.padding = "20px";
        card.style.backgroundColor = "#444444";
        card.style.boxShadow = "0 4px 8px black";
        card.style.flex = "1 1 calc(33% - 30px)";
        card.style.maxWidth = "calc(33% - 30px)";
        card.style.boxSizing = "border-box";
        card.style.lineHeight = "1.8";

        const head = document.createElement('div');
        head.textContent = item.sheetLabel;
        head.style.fontSize = "20px";
        head.style.fontWeight = "bold";
        head.style.color = "whitesmoke";
        head.style.fontFamily = "Lexend";
        head.style.paddingBottom = "5px";
        card.appendChild(head);

        Object.entries(item).forEach(([key, value]) => {
          if (key === "sheetLabel") return;

          const field = document.createElement('div');
          field.style.fontSize = "16px";
          field.style.fontWeight = "bold";

          if (key.toLowerCase().includes("date")) {
            value = FormatDate(value);
          }

          // Style color for easy reading
          switch (value) {
            case "Promotion":
              field.style.color = "#34a853";
              break;
            case "Demotion":
              field.style.color = "#ff2f2f";
              break;
            case "Removal":
              field.style.color = "#ff2f2f";
              break;
            case "Severe":
              field.style.color = "#ff2f2f";
              break;
            case "Transfer":
              field.style.color = "#8e7cc3";
              break;
            case "Passed Interview":
              field.style.color = "#3c78d8";
              break;
            default:
              field.style.color = "whitesmoke";
              break;
          }

          // Differentiate logger information
          if (key.includes("Logger")) {
            field.style.color = "gray";
          }

          field.style.fontFamily = "Lexend";
          field.textContent = `${key}: ${value !== null ? value : 'N/A'}`;
          card.appendChild(field);
        });

        cardContainer.appendChild(card);
      });

      outputDiv.appendChild(cardContainer);
      document.getElementById("loading-search").innerText = "";
      document.getElementById("searchLoading").setAttribute("style", "display: none;")
    }
    // ******************************************************************************************************

    // REQUEST HANDLERS *************************************************************************************
    let requestNum = 0;
    const accessType = document.getElementById("accessType").innerText;

    function handleAction(task, action) {
      // Get task data => querySelector() / querySelectorAll()
      const id = task.querySelector(".task-id").textContent.replace("ID: ", "");
      task.querySelector(".icon").innerHTML = '<div class="loader"></div>';
      clearInterval(requestInterval);

      google.script.run.withSuccessHandler(response => {
        const banner = document.getElementById("actionBanner");

        if (typeof response == "string") {
          banner.style.display = "block";
          banner.style.backgroundColor = "red";
          document.getElementById("requestType").innerText = `Failed: ${response}`;
          task.querySelector(".icon").innerHTML = "<i class='bx bx-calendar-check bx-tada-hover'></i>";
          setTimeout(() => {
            document.getElementById("actionBanner").style.display = "none";
          }, 2000);
        } else {
          task.remove();
          requestNum -= 1;

          if (requestNum > 0) {
            document.getElementById("requestButton").style.backgroundColor = "rgba(255, 0, 0, 0.1)";
            document.getElementById("requestButton").style.animation = "redBlob 2.5s infinite ease-in-out";
          } else {
            document.getElementById("requestButton").style.backgroundColor = "";
            document.getElementById("requestButton").style.animation = "";
          }
          
          banner.style.display = "block";
          action === "accepted" ? banner.style.backgroundColor = "green" : banner.style.backgroundColor = "red";
          document.getElementById("requestType").innerText = action;
          task.querySelector(".icon").innerHTML = "<i class='bx bx-calendar-check bx-tada-hover'></i>";
          setTimeout(() => {
            document.getElementById("actionBanner").style.display = "none";
          }, 2000);
        }
        FillRequests();
        requestInterval = setInterval(() => {
          FillRequests();
        }, 10000);
      }).withFailureHandler((error) => {
        console.log(error);
        task.querySelector(".icon").innerHTML = "<i class='bx bx-calendar-check bx-tada-hover'></i>";
        requestInterval = setInterval(() => {
          FillRequests();
        }, 10000);
      }).ManageRequests(action, id);
    }

    window.FillRequests = function() {
      requestNum = 0;
      if (accessType === "visitor" || accessType === "mod") return;
      google.script.run.withSuccessHandler(data => {
        data = JSON.parse(data);
        if (!Array.isArray(data)) return;
        document.getElementById("mainDiv").innerHTML = "";
        
        data.forEach(request => {
          GenerateRequest(request);
        });
      }).withFailureHandler(() => {
        console.log("Something went wrong while fetching requests");
      }).GetRequests();
    }

    FillRequests();
    let requestInterval = setInterval(() => {
      FillRequests();
    }, 10000);

    window.GenerateRequest = function(data) {
      let task = document.createElement("div");
      task.classList.add("task");
      
      let taskHeader = document.createElement("div");
      taskHeader.classList.add("task-header");
      
      let title = document.createElement("h3");
      title.textContent = data.title;
      title.style.fontSize = "20px";
      
      let icon = document.createElement("div");
      icon.classList.add("icon");
      icon.innerHTML = "<i class='bx bx-calendar-check bx-tada-hover'></i>";
      
      taskHeader.appendChild(title);
      taskHeader.appendChild(icon);
      
      let description = document.createElement("p");
      description.innerHTML = data.desc.replace(/\n/g, "<br>");
      
      let type = document.createElement("p");
      type.textContent = "Type: " + data.type;
      
      let addedBy = document.createElement("p");
      addedBy.textContent = "Requested by: " + data.logger;

      let taskFooter = document.createElement("div");
      taskFooter.classList.add("task-footer");

      let taskMeta = document.createElement("div");
      taskMeta.classList.add("task-meta");

      let id = document.createElement("small");
      id.classList.add("task-id");
      id.textContent = "ID: " + data.id;
      
      let date = document.createElement("small");
      date.textContent = "Date: " + new Date().toLocaleDateString();
      
      let buttonGroup = document.createElement("div");
      buttonGroup.classList.add("button-group");
      
      let acceptBtn = document.createElement("button");
      acceptBtn.classList.add("accept-btn");
      acceptBtn.textContent = "Accept";
      acceptBtn.addEventListener("click", function() {
        handleAction(task, "accepted");
      });
      
      let denyBtn = document.createElement("button");
      denyBtn.classList.add("deny-btn");
      denyBtn.textContent = "Deny";
      denyBtn.addEventListener("click", function() {
        handleAction(task, "denied");
      });
      
      buttonGroup.appendChild(acceptBtn);
      buttonGroup.appendChild(denyBtn);
      
      taskMeta.appendChild(id);
      taskMeta.appendChild(date);
      
      taskFooter.appendChild(taskMeta);
      taskFooter.appendChild(buttonGroup);
      
      task.appendChild(taskHeader);
      task.appendChild(description);
      task.appendChild(type);
      task.appendChild(addedBy);
      task.appendChild(taskFooter);
      
      let mainContainer = document.getElementById("mainDiv");
      mainContainer.insertBefore(task, mainContainer.firstChild);
      requestNum += 1;
      if (requestNum > 0) {
        document.getElementById("requestButton").style.backgroundColor = "rgba(255, 0, 0, 0.1)";
        document.getElementById("requestButton").style.animation = "redBlob 2.5s infinite ease-in-out";
      } else {
        document.getElementById("requestButton").style.backgroundColor = "";
        document.getElementById("requestButton").style.animation = "";
      }
    };
    // ******************************************************************************************************

    /* CONFIG HANDLERS *************************************************************************************
      All functions tasked with handing the configuration panel
    */

    try {
      google.script.run.withSuccessHandler(response => {
        try { document.getElementById("backupTime").innerText = `Last Backup made ${response} minutes ago`; } catch(e) {}
        // Make sure everything has the time to load
        setTimeout(() => {
          document.getElementById('config-textbox').style.display = "block"; // This one appears to be the slowest
          document.getElementById('config-loading').innerHTML = '';
        }, 1000);
      }).GetLastBackupTime();

      SetSliders();
      SetRankSelects(true);
    } catch (e) {  }

    document.getElementById('manualEditingSlider').addEventListener('change', function () {
      try { clearInterval(configupdate) } catch(e) { }
      document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
      google.script.run.withSuccessHandler(() => {
        document.getElementById('config-loading').innerHTML = '';
        StartConfigInterval();
      }).ToggleManualEditing(this.checked);
    });

    document.getElementById('pingSlider').addEventListener('change', function () {
      try { clearInterval(configupdate) } catch(e) {  }
      document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
      google.script.run.withSuccessHandler(() => {
        document.getElementById('config-loading').innerHTML = '';
        StartConfigInterval();
      }).TogglePings(this.checked);
    });

    try {
      document.getElementById('backupSlider').addEventListener('change', function () {
        try { clearInterval(configupdate) } catch(e) { }
        document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
        google.script.run.withSuccessHandler(() => {
          document.getElementById('config-loading').innerHTML = '';
          StartConfigInterval();
        }).ToggleBackup(this.checked);
      });
    } catch(e) {}

    window.LockdownInit = function (event) {
      event.preventDefault();
      document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
      const button = document.getElementById('lockdownButton');
      button.disabled = true;

      google.script.run.withSuccessHandler((re) => {
        document.getElementById('config-loading').innerHTML = '';

        if (re) {
          button.classList.add("red");
          button.innerText = re;
          Shake();
        } else {
          SetSliders();
          button.classList.add("green");
        }

        setTimeout(() => {
          button.disabled = false;
          button.innerText = "Lockdown";
          button.classList.remove("red");
          button.classList.remove("green");
        }, 4000);
      }).withFailureHandler((error) => {
        document.getElementById('config-loading').innerHTML = '';
        button.disabled = false;
      }).ToggleLockdown();
    };

    window.AddRankRow = function (event) {
      event.preventDefault();
      let rankElement = document.getElementById('new-rank-select');
      const rank = rankElement.value;
      let rowAmount = document.getElementById("rankRowAmount").value;
      rowAmount = Number(rowAmount);

      if (!rank) return Shake();
      if (!rowAmount || rowAmount <= 0 || rowAmount > 15) {
        Shake();
        if (rowAmount) alert("You must select a number of rows to add between 1 and 15");
        return;
      }

      const buttonAdd = document.getElementById('addrankrow-button');
      const buttonRemove = document.getElementById('removerankrow-button');
      let configLoading = document.getElementById('config-loading');

      if (configLoading.innerHTML == '<div class="loader"></div>') return Shake();

      configLoading.innerHTML = '<div class="loader"></div>';
      buttonAdd.disabled = true;
      buttonRemove.disabled = true;
      rankElement.disabled = true;

      google.script.run.withSuccessHandler(response => {
        configLoading.innerHTML = '';
        buttonAdd.classList.add('green');
        buttonRemove.classList.add('green');
        setTimeout(() => {
          buttonAdd.classList.remove('green');
          buttonRemove.classList.remove('green');
          buttonAdd.disabled = false;
          buttonRemove.disabled = false;
          rankElement.disabled = false;
        }, 3000);
      }).withFailureHandler((error) => {
        
        Shake();
        configLoading.innerHTML = '';
        configLoading.innerText = "Something went wrong while adding a rank slot";
        buttonAdd.classList.add('red');
        buttonRemove.classList.add('red');
        setTimeout(() => {
          configLoading.innerText = ""
          buttonAdd.disabled = false;
          buttonRemove.disabled = false;
          rankElement.disabled = false;
          buttonAdd.classList.remove('red');
          buttonRemove.classList.remove('red');
        }, 3000);
      }).AddRankRow(rank, rowAmount);
    };

    window.RemoveRankRow = function (event) {
      event.preventDefault();
      const rankElement = document.getElementById('new-rank-select');
      const rank = rankElement.value;
      let rowAmount = document.getElementById("rankRowAmount").value;
      rowAmount = Number(rowAmount);

      if (!rowAmount || rowAmount <= 0) {
        Shake();
        return;
      }

      const buttonAdd = document.getElementById('addrankrow-button');
      const buttonRemove = document.getElementById('removerankrow-button');
      let configLoading = document.getElementById('config-loading');

      if (configLoading.innerHTML == '<div class="loader"></div>') return Shake();

      configLoading.innerHTML = '<div class="loader"></div>';
      buttonAdd.disabled = true;
      buttonRemove.disabled = true;
      rankElement.disabled = true;

      if (!rank) {
        Shake();
        configLoading.innerHTML = '';
        buttonAdd.disabled = false;
        buttonRemove.disabled = false;
        rankElement.disabled = false;
        return;
      }

      google.script.run.withSuccessHandler(response => {
        configLoading.innerHTML = '';
        if (response) {
          buttonAdd.classList.add('red');
          buttonRemove.classList.add('red');
          Shake();
          setTimeout(() => {
            buttonAdd.classList.remove('red');
            buttonRemove.classList.remove('red');
            buttonAdd.disabled = false;
            buttonRemove.disabled = false;
            rankElement.disabled = false;
          }, 3000);
        } else {
          buttonAdd.classList.add('green');
          buttonRemove.classList.add('green');
          setTimeout(() => {
            buttonAdd.classList.remove('green');
            buttonRemove.classList.remove('green');
            buttonAdd.disabled = false;
            buttonRemove.disabled = false;
            rankElement.disabled = false;
          }, 3000);
        }
      }).withFailureHandler(error => {
        
        Shake();
        configLoading.innerHTML = '';
        configLoading.innerText = "Something went wrong while adding a rank slot";
        buttonAdd.classList.add('red');
        buttonRemove.classList.add('red');
        setTimeout(() => {
          configLoading.innerText = ""
          buttonAdd.disabled = false;
          buttonRemove.disabled = false;
          rankElement.disabled = false;
          buttonAdd.classList.remove('red');
          buttonRemove.classList.remove('red');
        }, 3000);
      }).RemoveRankRow(rank, rowAmount);
    };

    window.RestoreBackup = function (event) {
      event.preventDefault();
      try {
        const button = document.getElementById('restoreBackupButton');
        document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
        button.disabled = true;

        google.script.run.withSuccessHandler(response => {
          document.getElementById('config-loading').innerHTML = '';
          if (response) {
            button.classList.add("red");
            setTimeout(() => {
              button.classList.remove("red");
              button.disabled = false;
            }, 2000);
          } else {
            button.disabled = false;
          }
        }).withFailureHandler(error => {
          
          document.getElementById('config-loading').innerHTML = '';
          button.disabled = false;
          button.classList.add("red");
          setTimeout(() => button.classList.remove("red"), 2000);
        }).RestoreSheet();
      } catch(e) {
        document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
        document.getElementById('restoreBackupButton').disabled = true;
      }
    };

    window.MakeBackup = function (event) {
      event.preventDefault();
      try {
        const button = document.getElementById('backupButton');
        document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
        button.disabled = true;

        google.script.run.withSuccessHandler(response => {
          document.getElementById('config-loading').innerHTML = '';
          if (response) {
            button.classList.add("red");
            setTimeout(() => {
              button.classList.remove("red");
              button.disabled = false;
            }, 2000);
          } else {
            button.disabled = false;
          }

          // Update last backup time
          google.script.run.withSuccessHandler(response => {
            document.getElementById("backupTime").innerText = `Last Backup made ${response} minutes ago`;
          }).GetLastBackupTime();
        }).withFailureHandler(error => {
          
          document.getElementById('config-loading').innerHTML = '';
          button.disabled = false;
          button.classList.add("red");
          setTimeout(() => button.classList.remove("red"), 2000);
        }).Trigger_BackupSheet();
      } catch(e) {
        document.getElementById('config-loading').innerHTML = '';
        document.getElementById('backupButton').disabled = false;
      }
    };

    window.RefreshBackupTime = function (event) {
      event.preventDefault();
      try {
        document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
        google.script.run.withSuccessHandler(response => {
          document.getElementById("backupTime").innerText = `Last Backup made ${response} minutes ago`;
          document.getElementById('config-loading').innerHTML = '';
        }).GetLastBackupTime();
      } catch(e) { 
        document.getElementById('config-loading').innerHTML = '';
      }
    }

    window.ResetPerms = function (event) {
      event.preventDefault();
      const button = document.getElementById('resetButton');
      button.disabled = true;
      document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(response => {
        document.getElementById('config-loading').innerHTML = '';
        if (response) {
          button.classList.add("red");
          button.innerText = response;
          Shake();
          console.log(`${response} has Deleted their account or blocked you. This means we cannot share documents with this account, making resetting permissions impossible`);
        } else {
          button.classList.add("green");
        }
        
        setTimeout(() => {
          button.disabled = false;
          button.innerText = "Reset";
          button.classList.remove("red");
          button.classList.remove("green");
        }, 4000);
      }).withFailureHandler(error => {
        
        button.disabled = false;
        document.getElementById('config-loading').innerHTML = '';
      }).ResetPermissions();
    }

    window.SaveRanks = function (event, mod = true) {
      event.preventDefault();

      let button;
      let accessRank;

      if (mod) {
        button = document.getElementById('ModRankButton');
        accessRank = document.getElementById("mod-role-select").value;
      } else {
        button = document.getElementById('ManagerRankButton');
        accessRank = document.getElementById("manager-role-select").value;
      }

      button.disabled = true;
      let rank = document.getElementById("rank").innerText;
      let ranks = document.getElementById("ranks")?.innerText;
      ranks = ranks.split(",");

      if (!accessRank) {
        Shake();
        button.disabled = false;
        return;
      }

      if ((ranks.indexOf(accessRank) >= ranks.indexOf(rank)) && !rank.includes("Blackshadow Staff")) {
        Shake();
        button.disabled = false;
        console.log("You cannot manage rank access above your own rank");
        return;
      }

      google.script.run.withSuccessHandler((updatedarray) => {
        if (updatedarray.includes("Invalid") || updatedarray.includes("Roster")) {
          Shake();
          button.classList.add("red");
          button.innerText = updatedarray;
          setTimeout(() => {
            button.classList.remove("red");
            button.innerText = "Add/Remove";
            button.disabled = false;

            if (mod) {
              document.getElementById("config-form-modRanks").reset();
            } else {
              document.getElementById("config-form-managerRanks").reset();
            }
          }, 2000);
        } else {
          InsertRanks(updatedarray, mod);
          button.classList.add("green");
          setTimeout(() => {
            button.classList.remove("green")
          }, 2000);
        }
      }).withFailureHandler(error => {
        
        button.disabled = false;
      }).UpdateAccess(accessRank, rank, mod);
    };

    window.InsertRanks = function (ranks, mod) {
      ranks = JSON.parse(ranks);

      ranks.forEach((rankArray, i) => {
        let button;
        let form;
        let ranksElement;

        if (i === 0) {
          button = document.getElementById('ModRankButton');
          form = document.getElementById("config-form-modRanks");
          ranksElement = document.getElementById("modRanks");
        } else {
          button = document.getElementById('ManagerRankButton');
          form = document.getElementById("config-form-managerRanks");
          ranksElement = document.getElementById("managerRanks");
        }

        ranksElement.innerText = rankArray.join(", ");
        button.disabled = false;
        form.reset();
      });
    };

    window.SubmitChangelog = function(event) {
      event.preventDefault();
      let changelog = document.getElementById("changes").value;
      const button = document.getElementById("changelogButton");

      if (changelog.length < 20) {
        Shake();
        return;
      }

      button.disabled = true;
      google.script.run.withSuccessHandler(() => {
        button.disabled = false;
        document.getElementById("changelog-form").reset();
      }).withFailureHandler(() => {
        button.disabled = false;
      }).SubmitChange(changelog);
    };

    document.getElementById("new-rank-select").addEventListener("change", () => {
      let rank = document.getElementById("new-rank-select").value;
      document.getElementById("currentSlotsName").innerText = rank;
      document.getElementById("currentSlotsNum").innerText = " ";

      if (!rank) return;
      google.script.run.withSuccessHandler(slots => {
        document.getElementById("currentSlotsNum").innerText = Number(slots);
      }).ReturnTotalSlots(rank);
    });

    // *********** DROPDOWN HANDLERS ************

    let coll = document.getElementById("manageRank");

    coll.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("newRankContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });

    let coll2 = document.getElementById("manageSpecialization");

    coll2.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("manageSpecContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });

    let coll3 = document.getElementById("manageCooldown");

    coll3.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("manageCooldownContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
      google.script.run.withSuccessHandler(r => {
        r = JSON.parse(r);
        document.getElementById("loaCooldown").value = r[0];
        document.getElementById("promoCooldown").value = r[1];
      }).ReturnCooldown();
    });

    let coll4 = document.getElementById("manageThreshold");

    coll4.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("manageThresholdContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
      google.script.run.withSuccessHandler(r => {
        r = JSON.parse(r);
        document.getElementById("threshold").value = r[0];
        document.getElementById("thresholdActionSelect").value = r[1];
      }).ReturnThreshold();
    });

    let coll5 = document.getElementById("registeredListButton");

    coll5.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("registeredListContent");
      content.innerHTML = '<div class="loader"></div>';

      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }

      google.script.run.withSuccessHandler(r => {
        r = JSON.parse(r);
        
        content.innerHTML = "";
        r.forEach(doc => {
          const docElement = document.createElement("div");

          docElement.innerHTML = `<p><strong>${doc.title}</strong></p>
            <br><p>ID: ${doc.id}</p>
            <br><p>Type: ${doc.type}</p>`;
          docElement.style.marginBottom = "10px";
          docElement.style.borderRadius = "10px";
          docElement.style.color = "whitesmoke";
          docElement.style.backgroundColor = "#222222"
          docElement.style.width = "70%";
          docElement.style.textAlign = "center";
          docElement.style.justifySelf = "center";

          content.appendChild(docElement)
        })
      }).ReturnRegistered();
    });

    let coll6 = document.getElementById("generalConfig");

    coll6.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("generalConfigContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });

    let coll7 = document.getElementById("manageMerits");

    coll7.addEventListener("click", function() {
      this.classList.toggle("active");
      var content = document.getElementById("manageMeritsContent");
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });

    const meritSlider = document.getElementById("meritActionPoints");
    const meritSliderOutput = document.getElementById("meritSliderOutput");

    meritSlider.oninput = function() {
      meritSliderOutput.innerText = this.value;
    }

    // **********************************************

    window.ExtractReqs = function() {
      const reqs = [];
      let valid = true;

      document.querySelectorAll(".req").forEach(task => {
        const title = task.querySelector(".title").value;
        const desc = task.querySelector(".description").value;
        const completionType = task.querySelector(".completion_type").value;
        const formula = completionType === "formula" ? task.querySelector(".formula").value : "";

        if (!title || !desc || title.length > 16 || desc.length > 300 || !completionType) return valid = false;
        
        reqs.push({ title, desc, completion_type: completionType, formula });
      });

      if (!valid) return "invalid";
      return reqs;
    }

    window.AddNewRank = function (event) {
      event.preventDefault();
      let button = document.getElementById("newrank-button");
      const hierarchySelect = document.getElementById("new-rank-before-select");
      const reqs = ExtractReqs();
      if (reqs === "invalid") return Shake();

      console.log(reqs);

      let data = {
        title: document.getElementById("newRankTitle").value,
        rankBefore: hierarchySelect.value,
        viewerFolders: document.getElementById("newRankViewFolders").value,
        editorFolders: document.getElementById("newRankEditFolders").value,
        editRank: document.getElementById("editRankSelect").value,
        interviewRequired: document.getElementById("interviewNeeded").checked,
        promoReqs: reqs,
        group: document.getElementById("new-rank-group-select").value,
        minMeritScore: document.getElementById("meritsNeeded").value
      }

      if (!data.title || !data.group || (data.minMeritScore < 0 || data.minMeritScore > 25)) return Shake();

      // Permission check
      if (hierarchySelect.value == data.editRank && data.editRank !== "") {
        hierarchySelect.value = "";
        button.disabled = true;
        Shake();
        button.classList.add("red");
        button.innerText = "Cannot place a rank before itself"; //
        return setTimeout(() => {
          button.innerText = "Edit Existing Rank";
          button.classList.remove("red");
          button.disabled = false;
        }, 3000);
      }

      // Input sanitization
      let valid = true;
      Object.values(data).forEach(value => {
        if (typeof value === "string" && (value.includes('"') || value.includes("'") || value.includes("`") || value.includes("$") || value.includes("{") || value.includes("<"))) {
          valid = false;
        }
      });

      if (!valid) {
        Shake();
        button.innerText = "No special characters allowed in input values";
        button.disabled = true;
        setTimeout(() => {
          button.innerText = "Submit New Rank";
          button.disabled = false;
        }, 2000);
        return;
      }

      // Start submitting
      button.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler((returnVal) => {
        returnVal = JSON.parse(returnVal);
        const response = returnVal[0];
        const settings = returnVal[1];

        if (
          response.toLowerCase().includes("not") 
          || response.toLowerCase().includes("already") 
          || response.toLowerCase().includes("invalid")
          || response.toLowerCase().includes("unrelated")
          || response.toLowerCase().includes("must")
        ) {
          Shake();
          button.classList.add('red');
        } else {
          button.classList.add('green');
          document.getElementById("newrankForm").reset();
          document.getElementById("reqs").innerHTML = "";
          reqCount = 0;

          // Change mod/manager ranks (only really needed when title changed)
          document.getElementById("modRanks").innerText = settings.modRanks.join(", ");
          document.getElementById("managerRanks").innerText = settings.managerRanks.join(", ");
        }

        button.innerHTML = "";
        button.innerText = response;
        setTimeout(() => {
          button.innerText = "Submit New Rank";
          button.disabled = false;
          button.classList.remove('red');
          button.classList.remove('green');
        }, 3000);

        google.script.run.withSuccessHandler(ranks => {
          ranks = JSON.parse(ranks);
          document.getElementById("ranks").innerText = ranks;
          SetRankSelects(true);
        }).GetRanks();

      }).withFailureHandler(error => {
        

        // Manipulating button text to give info to user.
        button.innerHTML = "";
        button.innerText = "Something went wrong";
        setTimeout(() => {
          button.innerText = "Submit New Rank";
          button.disabled = false;
        }, 4000);
      }).AddNewRank(data);
    };

    window.RemoveRank = function(event) {
      event.preventDefault();
      const button = document.getElementById("removeRank-button");
      const rank = document.getElementById("remove-rank-select").value;

      if (!rank) return Shake();

      const proceed = confirm(`You are about to remove the rank of ${rank} from the roster. Press OK if you would like to continue this action.`);

      if (proceed == true) {
        button.disabled = true;
        document.getElementById('config-loading').innerHTML = '<div class="loader" style="width: 10px; height: 10px;"></div>';

        google.script.run.withSuccessHandler(response => {
          if (response.toLowerCase().includes("not") || response.toLowerCase().includes("invalid")) {
            Shake();
            response.toLowerCase().includes("not") ? button.innerText = "Population" : button.innerText = "Invalid";
            button.classList.add('red');
          } else {
            button.classList.add('green');
            button.innerText = "Success";
            document.getElementById("newrankForm").reset();
          }

          setTimeout(() => {
            button.innerText = "Delete";
            document.getElementById('config-loading').innerHTML = "";
            button.disabled = false;
            button.classList.remove('red');
            button.classList.remove('green');
          }, 3000);

          google.script.run.withSuccessHandler(ranks => {
            ranks = JSON.parse(ranks);
            document.getElementById("ranks").innerText = ranks;
            SetRankSelects(true);
          }).GetRanks();
        }).withFailureHandler(error => {
          
          button.disabled = false;
          button.innerText = "Delete";
          document.getElementById('config-loading').innerHTML = "";
        }).RemoveRank(rank);
      }
    };

    window.AddNewSpec = function(event) {
      event.preventDefault();
      const title = document.getElementById("specTitle").value;
      const desc = document.getElementById("specDesc").value;
      const editExisting = document.getElementById("editSpecSelect").value;
      const button = document.getElementById("spec-button");

      if (!title || !desc) return Shake();
      if (title.length > 20 || desc.length > 250) return Shake();

      const data = {
        title: title,
        desc: desc,
        editExisting: editExisting
      }

      // Input sanitization
      let valid = true;
      Object.values(data).forEach(value => {
        if (typeof value === "string" && (value.includes('"') || value.includes("'") || value.includes("`") || value.includes("$") || value.includes("{") || value.includes("<"))) {
          valid = false;
        }
      });

      if (!valid) {
        Shake();
        button.innerText = "No special characters allowed in input values";
        button.disabled = true;
        setTimeout(() => {
          button.innerText = "Submit New Rank";
          button.disabled = false;
        }, 2000);
        return;
      }

      button.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(response => {
        button.innerHTML = "";
        if (response.toLowerCase().includes("not")) {
          Shake();
          button.classList.add('red');
        } else {
          button.classList.add('green');
          document.getElementById("spec-form").reset();
        }

        button.innerText = response;
        setTimeout(() => {
          button.innerText = `${editExisting == "" ? "Submit New" : "Edit Existing"} Specialization`;
          button.disabled = false;
          button.classList.remove('red');
          button.classList.remove('green');
        }, 3000);

        SetSpecSelects();
      }).withFailureHandler(error => {
        
        button.innerHTML = "";
        button.innerText = "Something went wrong";
        setTimeout(() => {
          button.innerText = `${editExisting == "" ? "Submit New" : "Edit Existing"} Specialization`;
          button.disabled = false;
        }, 3000);
      }).AddSpec(title, desc, editExisting);
    };

    window.RemoveExistingSpec = function(event) {
      event.preventDefault();
      const title = document.getElementById("removeSpec").value;
      const button = document.getElementById("removespec-button");

      if (!title) return Shake();

      button.disabled = true;

      google.script.run.withSuccessHandler(response => {
        if (response.includes("not")) {
          Shake();
          button.classList.add('red');
        } else {
          button.classList.add('green');
          document.getElementById("removespec-form").reset();
        }

        setTimeout(() => {
          button.disabled = false;
          button.classList.remove('red');
          button.classList.remove('green');
        }, 1000);

        SetSpecSelects();
      }).withFailureHandler(error => {
        console.log(error);
        button.disabled = false;
      }).RemoveSpec(title);
    };

    window.FillSpec = function(event) {
      event.preventDefault();
      const select = document.getElementById("editSpecSelect");
      const titleField = document.getElementById("specTitle");
      const descField = document.getElementById("specDesc");
      const button = document.getElementById("spec-button");

      if (select.value == "") {
        titleField.value = "";
        descField.value = "";
        button.disabled = false;
        select.disabled = false;
        return button.innerText = "Submit New Specialization";
      }

      button.disabled = true;
      select.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(content => {
        content = JSON.parse(content);
        if (content.length !== 2) {
          button.innerText = "Rank not found";
          button.classList.add("red");
          setTimeout(() => {
            button.disabled = false;
            select.disabled = false;
            button.innerText = "Edit Existing Specialization";
            return;
          }, 3000); 
        }

        titleField.value = content[0];
        descField.value = content[1];

        button.disabled = false;
        select.disabled = false;
        button.innerHTML = '';
        button.innerText = "Edit Existing Specialization";
      }).withFailureHandler(() => {
        button.innerHTML = "";
        button.innerText = "Something went wrong";
        setTimeout(() => {
          button.innerText = "Submit New Specialization";
          button.disabled = false;
          select.disabled = false;
        }, 3000);
      }).GetSpecContent(select.value);
    };

    window.FillRank = function(event) {
      event.preventDefault();

      const select = document.getElementById("editRankSelect");
      const titleInput = document.getElementById("newRankTitle");
      const hierarchySelect = document.getElementById("new-rank-before-select");
      const groupSelect = document.getElementById("new-rank-group-select");
      const viewFoldersInput = document.getElementById("newRankViewFolders");
      const editFoldersInput = document.getElementById("newRankEditFolders");
      const hasInterviewSlider = document.getElementById("interviewNeeded");
      const minMeritsSelect = document.getElementById("meritsNeeded")
      const reqDiv = document.getElementById("reqs");
      const button = document.getElementById("newrank-button");
      const form = document.getElementById("newrankForm");

      if (select.value == "") {
        form.reset();
        button.disabled = false;
        reqDiv.innerHTML = "";
        reqCount = 0;
        return button.innerText = "Submit New Rank";
      }

      button.disabled = true;
      select.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(content => {
        content = JSON.parse(content);
        if (content.length !== 8) {
          button.innerText = "Rank not found";
          button.classList.add("red");
          return setTimeout(() => {
            form.reset();
            button.classList.remove("red");
            button.disabled = false;
            select.disabled = false;
            button.innerText = "Edit Existing Rank";
          }, 3000); 
        }

        titleInput.value = content[0];
        hierarchySelect.value = content[1];
        groupSelect.value = content[6];
        minMeritsSelect.value = content[7]

        /* Map for better styling & user experience (if not, it's just a series of bunched up characters)
          It's literally just one space, but it makes a difference
        */
        viewFoldersInput.value = content[2].map((id, i) => {
          switch (i) {
            case 0:
              return `${id}`;
            default:
              return ` ${id}`      
          }
        });

        editFoldersInput.value = content[3].map((id, i) => {
          switch (i) {
            case 0:
              return `${id}`;
            default:
              return ` ${id}`      
          }
        });

        hasInterviewSlider.checked = (content[4] === "true");
        document.getElementById("reqs").innerHTML = "";
        if (content[5]) content[5].forEach(req => {
          AddReq(null, req);
        });

        button.disabled = false;
        select.disabled = false;
        button.innerHTML = "";
        button.innerText = "Edit Existing Rank";
      }).withFailureHandler(error => {
        button.innerText = "something went wrong";
        button.classList.add("red");
        setTimeout(() => {
          form.reset();
          button.disabled = false;
          select.dsiabled = false;
          button.classList.remove("red");
          select.value = "";
          button.innerText = "Submit New Rank";
        }, 3000);
      }).GetRankContent(select.value);
    };

    window.FillMeritAction = function () {
      const button = document.getElementById("meritAction-button");
      const action = document.getElementById("editMeritActionSelect").value;
      const title = document.getElementById("meritActionTitle");
      const desc = document.getElementById("meritActionDesc");
      const meritCount = document.getElementById("meritActionPoints");
      const meritOutput = document.getElementById("meritSliderOutput");

      if (!action || action === "") return;

      button.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(response => {
        response = JSON.parse(response);

        title.value = response[0];
        desc.value = response[1];
        meritCount.value = response[2];
        meritOutput.innerText = response[2];

        button.disabled = false;
        button.innerHTML = "";
        button.innerText = "Submit";
      }).FillMerit(action);
    }

    window.ManageAllFolders = function(event) {
      event.preventDefault();
      let id = document.getElementById("newFolderId").value;
      const button = document.getElementById("newfolder-button");
      id = id.replace(/\s+/g, "");
      if (!id) return Shake();

      button.disabled = true;

      google.script.run.withSuccessHandler(response => {
        if (response.toLowerCase().includes("no") || response.toLowerCase().includes("invalid")) {
          button.classList.add("red");
          Shake();
          return setTimeout(() => {
            button.disabled = false;
            button.classList.remove("red");
          }, 3000);
        } else {
          button.classList.add("green");
          response.includes("removed") ? button.innerText = "Removed" : button.innerText = "Added";
          return setTimeout(() => {
            button.disabled = false;
            button.classList.remove("green");
            button.innerText = "Manage";
            document.getElementById("config-new-folder").reset();
          }, 3000);
        }
      }).withFailureHandler(error => {
        console.log(error);
        button.classList.add("red");
        Shake();
        return setTimeout(() => {
          button.disabled = false;
          button.classList.remove("red");
        }, 3000);
      }).AddFolder(id);
    }

    window.ChangeLOACooldown = function(event) {
      event.preventDefault();
      const days = document.getElementById("loaCooldown").value;
      const button = document.getElementById("loaCooldown-button");
      if (Number(days) > 60 || Number(days) < 0 || !days) return Shake();

      button.disabled = true;

      google.script.run.withSuccessHandler(response => {
        if (!response) {
          button.classList.add("green");
          button.innerText = "Edited";
          setTimeout(() => {
            button.classList.remove("green");
            button.innerText = "Change";
            button.disabled = false;
          }, 3000);
        } else {
          button.classList.add("red");
          button.innerText = "Invalid";
          setTimeout(() => {
            button.classList.remove("red");
            button.innerText = "Change";
            button.disabled = false;
          }, 3000);
        }
      }).withFailureHandler(() => {
        button.classList.add("red");
        button.innerText = "Error";
        setTimeout(() => {
          button.classList.remove("red");
          button.innerText = "Change";
          button.disabled = false;
        }, 3000);
      }).ChangeLOACooldown(days);
    };

    window.ChangePromoCooldown = function(event) {
      event.preventDefault();
      const days = document.getElementById("promoCooldown").value;
      const button = document.getElementById("promoCooldown-button");
      if (Number(days) > 60 || Number(days) < 0 || !days) return Shake();

      button.disabled = true;

      google.script.run.withSuccessHandler(response => {
        if (!response) {
          button.classList.add("green");
          button.innerText = "Edited";
          setTimeout(() => {
            button.classList.remove("green");
            button.innerText = "Change";
            button.disabled = false;
          }, 3000);
        } else {
          button.classList.add("red");
          button.innerText = "Invalid";
          setTimeout(() => {
            button.classList.remove("red");
            button.innerText = "Change";
            button.disabled = false;
          }, 3000);
        }
      }).withFailureHandler(() => {
        button.classList.add("red");
        button.innerText = "Error";
        setTimeout(() => {
          button.classList.remove("red");
          button.innerText = "Change";
          button.disabled = false;
        }, 3000);
      }).ChangePromoCooldown(days);
    };

    window.ManageThreshold = function(event) {
      event.preventDefault();
      const infractions = document.getElementById("threshold");
      const action = document.getElementById("thresholdActionSelect");
      const button = document.getElementById("threshold-button");
      if (Number(infractions.value) > 10 || Number(infractions.value) < 1 || !infractions.value) return Shake();
      if (!action.value) return Shake();

      button.disabled = true;
      infractions.disabled = true;
      action.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(response => {
        button.innerHTML = "";
        button.innerText = response;
        if (!response.includes("not")) {
          button.classList.add("green");
          setTimeout(() => {
            button.classList.remove("green");
            button.innerText = "Submit";
            button.disabled = false;
            infractions.disabled = false;
            action.disabled = false;
          }, 3000);
        } else {
          button.classList.add("red");
          setTimeout(() => {
            button.classList.remove("red");
            button.innerText = "Submit";
            button.disabled = false;
            infractions.disabled = false;
            action.disabled = false;
          }, 3000);
        }
      }).withFailureHandler(() => {
        button.classList.add("red");
        button.innerText = "Something went wrong";
        setTimeout(() => {
          button.classList.remove("red");
          button.innerText = "Submit";
          button.disabled = false;
          infractions.disabled = false;
          action.disabled = false;
        }, 3000);
      }).ManageThreshold(infractions.value, action.value);
    };

    window.ManageMeritActions = function (event) {
      event.preventDefault();
      const button = document.getElementById("meritAction-button");
      const editTitle = document.getElementById("editMeritActionSelect").value;
      const title = document.getElementById("meritActionTitle").value;
      const desc = document.getElementById("meritActionDesc").value;
      let meritCount = document.getElementById("meritActionPoints").value;

      meritCount = Number(meritCount);

      if (!title || !desc || !meritCount) return Shake();
      if (meritCount > 5 || meritCount < 1) return Shake();
      if (title.length > 60 || desc.length > 200) return Shake();

      button.disabled = true;
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(response => {
        button.innerHTML = "";
        button.innerText = response;
        if (!response.includes("already")
          || !response.includes("Invalid")
          || !response.includes("Nothing")) {
          button.classList.add("green");
          GetMeritTitles();
          document.getElementById("manageMerit-form").reset();

          setTimeout(() => {
            button.classList.remove("green");
            button.innerText = "Submit";
            button.disabled = false;
          }, 3000);
        } else {
          button.classList.add("red");

          setTimeout(() => {
            button.classList.remove("red");
            button.innerText = "Submit";
            button.disabled = false;
          }, 3000);
        }
      }).withFailureHandler(() => {
        button.classList.add("red");
        button.innerText = "Something went wrong";
        setTimeout(() => {
          button.classList.remove("red");
          button.innerText = "Submit";
          button.disabled = false;
        }, 3000);
      }).ManageMeritAction(title, desc, meritCount, editTitle);
      // TODO
    };

    window.RemoveMeritAction = function(event) {
      event.preventDefault();
      const title = document.getElementById("removeMerit").value;
      const form = document.getElementById("removeMeritAction-form");
      const button = document.getElementById("removemerit-button");

      if (!title || title === "") return Shake();

      button.disabled = true;

      google.script.run.withSuccessHandler(response => {
        button.innerText = response;

        if (!response.includes("Invalid")) {
          button.classList.add("green");
          form.reset();
          GetMeritTitles();
        } else {
          button.classList.add("red");
        }

        setTimeout(() => {
          button.classList.remove('red');
          button.classList.remove("green");
          button.innerText = "Remove";
          button.disabled = false;
        }, 3000);
      }).withFailureHandler(error => {

      }).RemoveMeritAction(title)
    }

    // Give the collapsible menus their functionality
    document.getElementById('config-loading').innerHTML = '<div class="loader"></div>';
    document.getElementById("newRankContent").classList.add("collapseContent");
    document.getElementById("manageRank").classList.add("collapsible");
    document.getElementById("manageSpecContent").classList.add("collapseContent");
    document.getElementById("manageSpecialization").classList.add("collapsible");
    document.getElementById("manageCooldown").classList.add("collapsible");
    document.getElementById("manageCooldownContent").classList.add("collapseContent");
    document.getElementById("manageThreshold").classList.add("collapsible");
    document.getElementById("manageThresholdContent").classList.add("collapseContent");
    document.getElementById("registeredListButton").classList.add("collapsible");
    document.getElementById("registeredListContent").classList.add("collapseContent");
    document.getElementById("generalConfig").classList.add("collapsible");
    document.getElementById("generalConfigContent").classList.add("collapseContent");
    document.getElementById("manageMerits").classList.add("collapsible");
    document.getElementById("manageMeritsContent").classList.add("collapseContent");

    // Promotion Req Manager
    let reqCount = 0;
    window.AddReq = function (event = null, data = null) {
      if (event) event.preventDefault();
      if (!data) {
        data = {
          title: '',
          desc: '',
          completion_type: 'manual',
          formula: ''
        };
      }

      if (reqCount >= 5) return alert("You can only have 5 promo reqs.");
      
      const reqContainer = document.getElementById("reqs");
      const reqDiv = document.createElement("div");
      reqDiv.className = "req";
      
      // I've removed the option to add a custom formula (completion_type select is hidden & no option for formula)
      reqDiv.innerHTML = `
        <input type="text" class="title" placeholder="Promotion Requirement Name" maxlength="16" style="font-weight: bold; display: block; width: 40%;" value="${data.title}" required/>
        <input type="text" class="description" placeholder="Promotion Requirement Description" maxlength="300" style="display: block; width: 100%; margin-top: 5px;" value="${data.desc}" required/>
        <select class="completion_type" style="display: none; margin-top: 5px; width: 100%;" required>
          <option value="manual">Manual</option>
        </select>
        <input type="text" class="formula" placeholder="Enter custom formula" style="display: none; margin-top: 5px; width: 100%;" value="${data.formula}"/>
        <button class="submitButton-mini" style="position: absolute; top: 5px; right: 5px; background-color: red;">Delete</button>
      `;
      
      reqDiv.style = "position: relative; padding: 10px; margin-bottom: 20px; width: 80%;";
      
      // Removed custom formula option
      // reqDiv.querySelector(".completion_type").addEventListener("change", function() {
      //   const formulaInput = reqDiv.querySelector(".formula");
      //   formulaInput.style.display = this.value === "formula" ? "block" : "none";
      // });

      reqDiv.querySelector(".completion_type").value = data.completion_type;
      
      reqDiv.querySelector(".submitButton-mini").addEventListener("click", function() {
        reqDiv.remove();
        reqCount--;
      });
      
      reqContainer.prepend(reqDiv);
      reqCount++;
    }

    // CONFIG ENABLING/DISABLING REQUIREMENTS ******************************

    window.ToggleReqsDisabled = function (event) {
      event.preventDefault();
      const button = document.getElementById("toggleReqsButton");
      const configLoading = document.getElementById("config-loading");

      if (configLoading.innerHTML == '<div class="loader"></div>') return Shake();

      configLoading.innerHTML = '<div class="loader"></div>';
      button.disabled = true;
      google.script.run.withSuccessHandler(value => {
        
        const identifier = document.getElementById("reqIdentifier");
        button.classList.add("green");
        if (value) {
          identifier.innerText = "Enable";
          button.innerText = "Reqs Disabled";
        } else {
          identifier.innerText = "Disable";
          button.innerText = "Reqs Enabled";
        }
        
        SetReqVis(value, false);

        configLoading.innerHTML = '';
        setTimeout(() => {
          button.classList.remove("green");
          button.innerText = "Requirements";
          button.disabled = false;
        }, 2000);
        
      }).withFailureHandler(err => {
        console.log(err);
        button.classList.add("red");
        button.innerText = "Error";
        configLoading.innerHTML = "";
        Shake();

        setTimeout(() => {
          button.classList.remove("red");
          button.disabled = false;
          button.innerText = "Requirements";
        }, 2000);
      }).ToggleReqs();
    }

    window.SetReqVis = function (value, onOpen) {
      // Set the visibility of certain elements depending on whether or not reqs are enabled
      if (typeof value === "string") {
        value = value === "true" ? true : false;
      }

      if (value) {
        // Reqs disabled
        if (accessType === "admin" || accessType === "dev") {
          document.getElementById("addReqButton").style.display = "none";
          document.getElementById("reqs").style.display = "none";
          document.getElementById("minMeritConfig").style.display = "none";
          document.getElementById("reqIdentifier").innerText = "Enable";
        }

        const logTypeList = document.getElementById("logTypeList");
        const optionToRemove = [...logTypeList.options].find(option => option.value === "Requirement Log");
        if (optionToRemove) {
          optionToRemove.remove();
        }
      } else {
        // Reqs enabled
        if (accessType === "admin" || accessType === "dev") {
          document.getElementById("addReqButton").style.display = "";
          document.getElementById("reqs").style.display = "block";
          document.getElementById("minMeritConfig").style.display = "";
          document.getElementById("reqIdentifier").innerText = "Disable";
        }

        if (onOpen) return;
        const reqLog = document.createElement("option");
        reqLog.value = "Requirement Log";
        reqLog.innerText = "Promotion Requirement Log";
        document.getElementById("logTypeList").appendChild(reqLog);
      }
    }
      
    // At opening of web app -> ensure req visibility is set
    google.script.run.withSuccessHandler(value => {
      SetReqVis(value, true)
    }).ReturnReqsDisabled();

    // ******************************************************************************************************

    // GENERAL LOG HANDLERS *********************************************************************************

    if (accessType === "visitor") {
      document.getElementById('namefield').setAttribute('style', 'display: none;');
      document.getElementById('playerIdfield').setAttribute('style', 'display: none;');
      document.getElementById('discordidfield').setAttribute('style', 'display: none;');
      document.getElementById('emailfield').setAttribute('style', 'display: none;');
      document.getElementById('reasonfield').setAttribute('style', 'display: block;');
      document.getElementById('infrtypelist').setAttribute('style', 'display: none;');
      document.getElementById('infrlabel').setAttribute('style', 'display: none;');
      document.getElementById('enddatefield').setAttribute('style', 'display: block;');
      document.getElementById('enddatelabelLOA').setAttribute('style', 'display: block;');
      document.getElementById('enddatelabelBL').setAttribute('style', 'display: none;');
      document.getElementById('appealable').setAttribute('style', 'display: none;');
      document.getElementById('appealablelabel').setAttribute('style', 'display: none;');
      document.getElementById('rctypefield').setAttribute('style', 'display: none;');
      document.getElementById('rctypelabel').setAttribute('style', 'display: none;');
      document.getElementById('idfield').setAttribute('style', 'display: none;');
      document.getElementById('idfieldlabel').setAttribute('style', 'display: none;');
      document.getElementById('bllabel').setAttribute('style', 'display: none;');
      document.getElementById('bltypelist').setAttribute('style', 'display: none;');
    }

    // Toggle which questions are visible depending on main selection
    window.HideCheck = function () {
      // lmk if there's a better way to do this then the setAttributes
      let logtype = document.getElementById('logTypeList').value;

      // Can be set seperate as they're almost always set to none (apart from New Member)
      document.getElementById('namefield').setAttribute('style', 'display: none;');
      document.getElementById('playerIdfield').setAttribute('style', 'display: none;');
      document.getElementById('discordidfield').setAttribute('style', 'display: none;');
      document.getElementById('emailfield').setAttribute('style', 'display: none;');
      document.getElementById("newMemberEmailField").setAttribute('style', 'display: none;');
      document.getElementById('reasonfield').setAttribute('style', 'display: none;');
      document.getElementById('infrtypelist').setAttribute('style', 'display: none;');
      document.getElementById('infrlabel').setAttribute('style', 'display: none;');
      document.getElementById('enddatefield').setAttribute('style', 'display: none;');
      document.getElementById('enddatelabelLOA').setAttribute('style', 'display: none;');
      document.getElementById('enddatelabelBL').setAttribute('style', 'display: none;');
      document.getElementById('appealable').setAttribute('style', 'display: none;');
      document.getElementById('appealablelabel').setAttribute('style', 'display: none;');
      document.getElementById('rctypefield').setAttribute('style', 'display: none;');
      document.getElementById('rctypelabel').setAttribute('style', 'display: none;');
      document.getElementById('idfield').setAttribute('style', 'display: none;');
      document.getElementById('idfieldlabel').setAttribute('style', 'display: none;');
      document.getElementById('bllabel').setAttribute('style', 'display: none;');
      document.getElementById('bltypelist').setAttribute('style', 'display: none;');
      document.getElementById('reqfield').setAttribute('style', 'display: none;');
      document.getElementById('reqfieldlabel').setAttribute('style', 'display: none;');
      document.getElementById('meritfield').setAttribute('style', 'display: none;');
      document.getElementById('meritfieldlabel').setAttribute('style', 'display: none;');
      document.getElementById("meritinfofield").setAttribute('style', 'display: none;');
      document.getElementById('reasonfield').placeholder = "Provide a reason for this log.";

      switch (logtype) {
        case 'Infraction Log':
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('infrtypelist').setAttribute('style', 'display: block;');
          document.getElementById('infrlabel').setAttribute('style', 'display: block;');
          break;
        case 'Rank Change':
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('rctypefield').setAttribute('style', 'display: block;');
          document.getElementById('rctypelabel').setAttribute('style', 'display: block;');
          break;
        case 'LOA Log':
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('enddatefield').setAttribute('style', 'display: block;');
          document.getElementById('enddatelabelLOA').setAttribute('style', 'display: block;');
          break;
        case 'Blacklist':
          document.getElementById('bllabel').setAttribute('style', 'display: block;');
          document.getElementById('bltypelist').setAttribute('style', 'display: block;');
          document.getElementById('bltypelist').value = "";
          break;
        case 'Infraction Appeal':
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('idfield').setAttribute('style', 'display: block;');
          document.getElementById('idfieldlabel').setAttribute('style', 'display: block;');
          break;
        case 'Blacklist Appeal':
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('idfield').setAttribute('style', 'display: block;');
          document.getElementById('idfieldlabel').setAttribute('style', 'display: block;');
          break;
        case 'New Member':
          document.getElementById('namefield').setAttribute('style', 'display: block;');
          document.getElementById('playerIdfield').setAttribute('style', 'display: block;');
          document.getElementById('discordidfield').setAttribute('style', 'display: block;');
          document.getElementById("newMemberEmailField").setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          break;
        case "Requirement Log":
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('reqfieldlabel').setAttribute('style', 'display: block;');
          document.getElementById('reqfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').placeholder = "Provide a visual (working image link) proof of completion.";

          // Get reqs of user's rank
          GetReqTitles();
          break;
        case "Merit Log":
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('meritfield').setAttribute('style', 'display: block;');
          document.getElementById('meritfieldlabel').setAttribute('style', 'display: block;');
          document.getElementById("meritinfofield").setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').placeholder = "Provide a visual (working image link) proof of completion.";

          // Get merit actions
          GetMeritTitles();
          break;
      }
      
      // Visitors don't have to input their email as they can only manage themselves
      if (accessType === "visitor") document.getElementById('emailfield').setAttribute('style', 'display: none;');
    }

    window.GetReqTitles = function() {
      // Get reqs of user's rank
      let rank = document.getElementById("rank").innerText;
      let email;

      // TODO: possibly change to dynamic check
      if (accessType === "admin" || accessType === "dev") {
        rank = null;
        email = document.getElementById('emailfield').value;
      }
      
      google.script.run.withSuccessHandler(response => {
        response = JSON.parse(response);
        if (typeof response === "string") return "Returned";
        
        try {
          const reqField = document.getElementById("reqfield");
          reqField.innerHTML = "<option value=''></option>";
          response.forEach(req => {
            const reqOption = document.createElement("option");
            reqOption.value = req.title;
            reqOption.innerText = req.title;
            reqField.appendChild(reqOption);
          });
        } catch(e) {
          console.log("Getting req titles failed: " + e);
        }
      }).GetReqs(rank, email);
    }

    document.getElementById("meritfield").addEventListener("change", () => {
      const value = document.getElementById("meritfield").value;

      if (value === "") {
        document.getElementById("meritInfoDesc").innerText = "";
        document.getElementById("meritInfoCount").innerText = "";
        return;
      }

      google.script.run.withSuccessHandler(response => {
        response = JSON.parse(response);

        document.getElementById("meritInfoDesc").innerText = response[1];
        document.getElementById("meritInfoCount").innerText = response[2];
      }).FillMerit(value);
    });

    // Get all current registered merit actions
    window.GetMeritTitles = function() {
      google.script.run.withSuccessHandler(response => {
        response = JSON.parse(response);
        if (typeof response === "string") return "Returned";
        
        try {
          const meritField = document.getElementById("meritfield");
          const meritEditSelect = document.getElementById("editMeritActionSelect");
          const removeMeritSelect = document.getElementById("removeMerit");

          [meritField, meritEditSelect, removeMeritSelect].forEach(select => {
            select.innerHTML = "<option value=''></option>";
            response.forEach(action => {
              const meritOption = document.createElement("option");
              meritOption.value = action;
              meritOption.innerText = action;
              select.appendChild(meritOption);
            });
          });
        } catch(e) {
          console.log("Getting merit action titles failed: " + e);
        }
      }).GetMeritActions();
    }

    // Set them immediately
    GetMeritTitles();

    // Prefill req field when loading web app
    GetReqTitles();

    // If you're not logging a req for yourself -> check the reqs of the person on every input change
    document.getElementById("emailfield").addEventListener("change", () => {
      if (accessType === "visitor") return;
      if (document.getElementById("logTypeList").value !== "Requirement Log") return;
      if (!document.getElementById("emailfield").value.includes("@")) return;
      if (!document.getElementById("emailfield").value.includes(".")) return;

      try {
        GetReqTitles();
      } catch(e) {
        console.log("Getting req titles failed");
      }
    });

    window.ResetUI = function (button, response) {
      button.innerHTML = "";
      button.innerText = response;
      setTimeout(() => {
        button.innerText = "Submit";
        button.disabled = false;
        button.classList.remove('red');
        button.classList.remove('green');
        HideCheck();
        console.log("Log sucessfully submitted");
      }, 4000);
      document.getElementById('rctypefield').value = "";
      document.getElementById('bltypelist').value = "";
    }

    window.UIEnd = function (button, response) {
      if (response.includes("not") || response.includes("capacity") || response.includes("only") || response.includes("must")) {
        Shake();
        button.classList.add('red');
        ResetUI(button, response[0]);
      } else if (!response.includes('something')) {
        document.getElementById('dataform').reset();
        HideCheck();
        button.classList.add('green');
        ResetUI(button, response[0]);
      }
    }

    // SUBMITING FORMS
    window.SubmitLog = function (event) {
      event.preventDefault();
      console.time("Log Submission Runtime");
      const button = document.getElementById("loggerSubmitButton");
      button.disabled = true;

      const value = document.getElementById('logTypeList').value;

      // Set some data if a New Member was logged so it can use the same script as Rank Change in the logger engine
      let data_type = value == "New Member" ? "Rank Change" : value;
      let data_rankchangetype = value == "New Member" ? "Passed Interview" : document.getElementById('rctypefield').value;
      let data_type_check = value == "New Member" ? "New Member" : value;
      let data_email = value == "New Member" ? document.getElementById('newMemberEmailField').value : document.getElementById('emailfield').value;

      const dataToSubmit = {
        type: data_type,
        type_check: data_type_check,
        name: document.getElementById('namefield').value,
        playerId: document.getElementById('playerIdfield').value,
        discordid: document.getElementById('discordidfield').value,
        email: data_email,
        rankchangetype: data_rankchangetype,
        reason: document.getElementById('reasonfield').value,
        infraction_type: document.getElementById('infrtypelist').value,
        end_date: document.getElementById('enddatefield').value,
        blacklist_appealable: document.getElementById('appealable').value,
        log_id: document.getElementById('idfield').value,
        blacklist_type: document.getElementById('bltypelist').value,
        reqName: document.getElementById("reqfield").value,
        meritAction: document.getElementById("meritfield").value
      };

      // Data validation -> check if correct data has been inputted
      let valid = false;
      switch (dataToSubmit.type_check) {
        case 'Rank Change':
          if (dataToSubmit.email.includes("@") && dataToSubmit.email.includes(".") && dataToSubmit.reason != '' && dataToSubmit.rankchangetype != '') { valid = true; }
          break;
        case 'Infraction Log':
          if (dataToSubmit.email.includes("@") && dataToSubmit.email.includes(".") && dataToSubmit.reason != '' && dataToSubmit.infraction_type != '') { valid = true; }
          break;
        case 'LOA Log':
          if (dataToSubmit.email.includes("@") && dataToSubmit.email.includes(".") && dataToSubmit.reason != '' && dataToSubmit.end_date != '') { valid = true; }

          // Don't check email for visitors as they can't input it
          if (accessType === "visitor" && dataToSubmit.reason != '' && dataToSubmit.end_date != '') valid = true;
          break;
        case 'Blacklist':
          if (dataToSubmit.email.includes("@") && dataToSubmit.email.includes(".") && dataToSubmit.end_date != '' && dataToSubmit.reason != '' && dataToSubmit.blacklist_appealable != '') {
            switch (dataToSubmit.blacklist_type) {
              case "Suspension":
                valid = true;
                break;
              case "Blacklist":
                if (dataToSubmit.name != '' && dataToSubmit.playerId != '' && dataToSubmit.discordid != '' && dataToSubmit.blacklist_type != '') valid = true;
                break;
              default:
                return Shake();
            }
          }
          break;
        case 'Infraction Appeal':
          if (dataToSubmit.reason != '' && dataToSubmit.log_id >= 7) valid = true;
          break;
        case 'Blacklist Appeal':
          if (dataToSubmit.log_id >= 7) valid = true;
          break;
        case "New Member":
          if (dataToSubmit.email.includes('.') && dataToSubmit.email.includes('@') && dataToSubmit.playerId.length === 5 && dataToSubmit.reason != '') valid = true;
          break;
        case "Requirement Log":
          if (dataToSubmit.email.includes('.') && dataToSubmit.email.includes('@') && dataToSubmit.reason.length > 10 && dataToSubmit.reqName != '') valid = true;

          // Don't check email for visitors as they can't input it
          if (accessType === "visitor" && dataToSubmit.reason.length > 10 && dataToSubmit.reqName != '') valid = true;
          break;
        case "Merit Log":
          if (dataToSubmit.email.includes('.') && dataToSubmit.email.includes('@') && dataToSubmit.reason.length > 10 && dataToSubmit.meritAction != '') valid = true;

          // Don't check email for visitors as they can't input it
          if (accessType === "visitor" && dataToSubmit.reason.length > 10 && dataToSubmit.meritAction != '') valid = true;
          break;
        default:
          button.disabled = false;
          return Shake();
      }

      if (!valid) {
        Shake();
        console.log(dataToSubmit.email.includes('.') && dataToSubmit.email.includes('@') && dataToSubmit.playerId.length === 5 && dataToSubmit.reason != '')
        button.innerText = "Invalid Input";
        button.disabled = true;
        setTimeout(() => {
          button.innerText = "Submit";
          button.disabled = false;
        }, 1000);
        return;
      }

      Object.values(dataToSubmit).forEach(value => {
        if (!value) return;
        if (value && (value.includes('"') || value.includes("'") || value.includes("`") || value.includes("$") || value.includes("{") || value.includes("<"))) {
          valid = false;
        }
      });

      if (!valid) {
        Shake();
        button.innerText = "No special characters allowed in input values";
        button.disabled = true;
        setTimeout(() => {
          button.innerText = "Submit";
          button.disabled = false;
        }, 2000);
        return;
      }

      let proceed;

      // Make sure that the user has 2FA enabled on their account (there is no way to verify this with a script, so we'll have to trust the logger)
      if (dataToSubmit.type_check === "New Member") {
        proceed = confirm(`Are you sure that ${dataToSubmit.email} has 2-step verification enabled on their google account?
          \nIf you are unsure of this, please confirm with the user that their account has 2-step verification to ensure security of your faction's documentation and prevent any account hacks from causing issues
          \nIf you are sure they have 2-step verification enabled on ${dataToSubmit.email}, you can press OK.`);
        
        if (proceed == true) {
          console.log("Proceeding");
        } else {
          Shake();
          button.innerText = `Make sure ${dataToSubmit.email} has 2-Step verification enabled.`;
          button.disabled = true;
          setTimeout(() => {
            button.innerText = "Submit";
            button.disabled = false;
          }, 2000);
          return;
        }
      }

      // Actually submitting data
      if (valid === true) {
        button.innerText = "";
        button.innerHTML = '<div class="loader"></div>';
        google.script.run.withSuccessHandler(response => {
          try {
            response = JSON.parse(response);
            if (Number(response[1]) >= Number(response[2]) && dataToSubmit.type == "Infraction Log") {
              proceed = confirm(`The person you've just handed an infraction to has exceeded the infraction threshold (${response[2]}) as they currently have ${response[1]} infractions, click "OK" if you would like to execute a ${response[3]} to this user.`);
              if (proceed == true) {
                google.script.run.withSuccessHandler(() => {
                  ResetUI(button, response[0]);
                }).ProcessLog(dataToSubmit, true, accessType);
              } else {
                UIEnd(button, response)
              }
            } else {
              UIEnd(button, response);
            }
          } catch(e) {
              if (response.includes("not") || response.includes("capacity") || response.includes("only") || response.includes("must")) {
              Shake();
              button.classList.add('red');
              ResetUI(button, response);
            } else if (!response.includes('something')) {
              document.getElementById('dataform').reset();
              HideCheck();
              button.classList.add('green');
              ResetUI(button, response);
            }
          }

          console.timeEnd("Log Submission Runtime");
          SetEmailSelects();

        }).withFailureHandler(error => {
          

          // Manipulating button text to give info to user.
          button.innerHTML = "";
          button.innerText = "Something went wrong";
          setTimeout(() => {
            button.innerText = "Submit";
            button.disabled = false;
          }, 4000);
          console.timeEnd("Log Submission Runtime");

        }).ProcessLog(dataToSubmit, false, accessType);
      } else if (valid == false) {
        // Make screen shake if not all questions were answered (idk seemed fun)
        Shake();
        console.log("You did not fill out all questions correctly -- Submission failed");
        button.disabled = false;
        console.timeEnd("Log Submission Runtime");
      }
    }

    window.BlacklistToggle = function () {
      try {
        const blacklistTypeSelector = document.getElementById('bltypelist');
        if (blacklistTypeSelector.value == "Suspension") {
          document.getElementById('namefield').setAttribute('style', 'display: none;');
          document.getElementById('playerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('discordidfield').setAttribute('style', 'display: none;');
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('appealablelabel').setAttribute('style', 'display: block;');
          document.getElementById('appealable').setAttribute('style', 'display: block;');
          document.getElementById('enddatefield').setAttribute('style', 'display: block;');
          document.getElementById('enddatelabelBL').setAttribute('style', 'display: block;');
          document.getElementById('appealablelabel').innerText = "Is the Suspension appealable?";
          document.getElementById('enddatelabelBL').innerText = "Select expiry date of Suspension:";
        } else if (blacklistTypeSelector.value == "Blacklist") {
          document.getElementById('namefield').setAttribute('style', 'display: block;');
          document.getElementById('playerIdfield').setAttribute('style', 'display: block;');
          document.getElementById('discordidfield').setAttribute('style', 'display: block;');
          document.getElementById('emailfield').setAttribute('style', 'display: block;');
          document.getElementById('reasonfield').setAttribute('style', 'display: block;');
          document.getElementById('appealablelabel').setAttribute('style', 'display: block;');
          document.getElementById('appealable').setAttribute('style', 'display: block;');
          document.getElementById('enddatefield').setAttribute('style', 'display: block;');
          document.getElementById('enddatelabelBL').setAttribute('style', 'display: block;');
          document.getElementById('appealablelabel').innerText = "Is the Blacklist appealable?";
          document.getElementById('enddatelabelBL').innerText = "Select expiry date of Blacklist:";
        }
      } catch (e) {
        console.log("Blacklist Type edited");
      }
    }

    // **********************************************************************************************************

    // MANAGE VISIBILITY ON EDITS
    window.InfoHideCheck = function () {
      const infotype = document.getElementById('infoTypeList').value;
      switch (infotype) {
        case 'Edit Name':
          document.getElementById('newnamefield').setAttribute('style', 'display: block;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: none;');
          document.getElementById('newemailfield').setAttribute('style', 'display: none;');
          document.getElementById('newnotesfield').setAttribute('style', 'display: none;');
          document.getElementById('specfield').setAttribute('style', 'display: none;');
          break;
        case 'Edit playerId':
          document.getElementById('newnamefield').setAttribute('style', 'display: none;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: block;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: none;');
          document.getElementById('newemailfield').setAttribute('style', 'display: none;');
          document.getElementById('newnotesfield').setAttribute('style', 'display: none;');
          document.getElementById('specfield').setAttribute('style', 'display: none;');
          break;
        case 'Edit discordID':
          document.getElementById('newnamefield').setAttribute('style', 'display: none;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: block;');
          document.getElementById('newemailfield').setAttribute('style', 'display: none;');
          document.getElementById('newnotesfield').setAttribute('style', 'display: none;');
          document.getElementById('specfield').setAttribute('style', 'display: none;');
          break;
        case 'Edit Email':
          document.getElementById('newnamefield').setAttribute('style', 'display: none;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: none;');
          document.getElementById('newemailfield').setAttribute('style', 'display: block;');
          document.getElementById('newemailfield').maxlength = 70;
          document.getElementById('newnotesfield').setAttribute('style', 'display: none;');
          document.getElementById('specfield').setAttribute('style', 'display: none;');
          break;
        case 'Edit Specialization':
          document.getElementById('newnamefield').setAttribute('style', 'display: none;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: none;');
          document.getElementById('newemailfield').setAttribute('style', 'display: none;');
          document.getElementById('newnotesfield').setAttribute('style', 'display: none;');
          document.getElementById('specfield').setAttribute('style', 'display: block;');
          break;
        case 'Edit Note':
          document.getElementById('newnamefield').setAttribute('style', 'display: none;');
          document.getElementById('newplayerIdfield').setAttribute('style', 'display: none;');
          document.getElementById('newsdiscidfield').setAttribute('style', 'display: none;');
          document.getElementById('newemailfield').setAttribute('style', 'display: none;');
          document.getElementById('newnotesfield').setAttribute('style', 'display: block;');
          document.getElementById('specfield').setAttribute('style', 'display: none;');
          break;
      }
    }

    // Submit Edit Data
    window.SubmitEdit = function (event) {
      event.preventDefault();
      console.time("Edit Submission Runtime");
      const button = document.getElementById("editSubmitButton");
      button.disabled = true;

      const editdata = {
        type: document.getElementById('infoTypeList')?.value || '',
        current_email: document.getElementById('curremailfield')?.value || '',
        name: document.getElementById('newnamefield')?.value || '',
        playerId: document.getElementById('newplayerIdfield')?.value || '',
        discordid: document.getElementById('newsdiscidfield')?.value || '',
        email: document.getElementById('newemailfield')?.value || '',
        specialization: document.getElementById('specfield')?.value || '',
        notes: document.getElementById('newnotesfield')?.value || ''
      };

      let validEdit = false;
      switch (editdata.type) {
        case 'Edit Name':
          if (editdata.name != '' && editdata.current_email != '') { validEdit = true; }
          break;
        case 'Edit playerId':
          if (editdata.playerId != '' && editdata.current_email != '') { validEdit = true; }
          break;
        case 'Edit dicsordID':
          if (editdata.discordid != '' && editdata.current_email != '') { validEdit = true; }
          break;
        case 'Edit Email':
          if (editdata.email != '' && editdata.current_email != '') { validEdit = true; }
          break;
        case 'Edit Specialization':
          if (editdata.current_email != '') { validEdit = true; }
          break;
        case 'Edit Note':
          if (editdata.notes != '' && editdata.current_email != '') { validEdit = true; }
          break;
      }

      Object.values(editdata).forEach(value => {
      if (value && (value.includes('"') || value.includes("'") || value.includes("`") || value.includes("$") || value.includes("{") || value.includes("<"))) {
        validEdit = false;
      }
    });

    if (!validEdit) {
      Shake();
      button.innerText = "No special characters allowed in input values";
      button.disabled = true;
      setTimeout(() => {
        button.innerText = "Submit New Rank";
        button.disabled = false;
      }, 2000);
      return;
    }

      if (validEdit == true) {
        button.innerText = "";
        button.innerHTML = '<div class="loader"></div>';
        google.script.run.withSuccessHandler(response => {

          if (response.includes("not")) {
            Shake();
            button.classList.add('red');
          } else if (!response.includes('something')) {
            document.getElementById('editform').reset();
            InfoHideCheck();
            button.classList.add('green');
          }

          // Manipulating button text to give info to user.
          button.innerHTML = "";
          button.innerText = response;
          setTimeout(() => {
            button.innerText = "Submit";
            button.disabled = false;
            button.classList.remove('red');
            button.classList.remove('green');
          }, 4000);
          console.timeEnd("Edit Submission Runtime");
        }).withFailureHandler(error => {
          //

          // Manipulating button text to give info to user.
          button.innerHTML = "";
          button.innerText = "Something went wrong";
          setTimeout(() => {
            button.innerText = "Submit";
            button.disabled = false;
          }, 4000);
          console.timeEnd("Edit Submission Runtime");
        }).ProcessInputEdits(editdata, accessType);
      } else if (validEdit == false) {
        // Make screen shake if not all questions were answered (idk seemed fun)
        Shake();
        console.log("You did not fill out all questions correctly -- Submission failed");
        button.disabled = false;
        console.timeEnd("Edit Submission Runtime");
      }
    }

    // On open
    SetSpecSelects();

    document.getElementById('curremailfield').addEventListener('change', () => {
      const emailField = document.getElementById('curremailfield');
      const elements = ["newnamefield", "newplayerIdfield", "newsdiscidfield", "newnotesfield"];
      const button = document.getElementById('editSubmitButton');

      emailField.disabled = true;
      button.disabled = true;
      elements.forEach(elementId => document.getElementById(elementId).disabled = true);
      button.innerText = "";
      button.innerHTML = '<div class="loader"></div>';

      google.script.run.withSuccessHandler(targetData => {
        try {
          targetData = JSON.parse(targetData);
          if (!targetData.row) {
            elements.forEach(element => document.getElementById(element[0]).value = "");
            elements.forEach(elementId => document.getElementById(elementId).disabled = false);
            emailField.disabled = false;
            button.disabled = false;
            button.innerHTML = '';
            button.innerText = "Submit";
            return;
          }

          document.getElementById(elements[0]).value = targetData.name;
          document.getElementById(elements[1]).value = targetData.playerId;
          document.getElementById(elements[2]).value = targetData.discordId;
          document.getElementById(elements[3]).value = targetData.notes;

          elements.forEach(elementId => document.getElementById(elementId).disabled = false);
          emailField.disabled = false;
          button.disabled = false;
          button.innerHTML = '';
          button.innerText = "Submit";
        } catch (e) {
          
          emailField.disabled = false;
          button.disabled = false;
          elements.forEach(elementId => document.getElementById(elementId).disabled = false);
          button.innerHTML = '';
          button.innerText = "Submit";
        }
      }).withFailureHandler(error => {
        
        
        emailField.disabled = false;
        button.disabled = false;
        elements.forEach(elementId => document.getElementById(elementId).disabled = false);
        button.innerHTML = '';
        button.innerText = "Submit";
      }).ReturnUserData(emailField.value, true);
    });

    let specInterval;
    document.getElementById("infoTypeList").addEventListener("change", () => {
      if (document.getElementById("infoTypeList").value === "Edit Specialization") {
        SetSpecSelects();
        specInterval = setInterval(() => { SetSpecSelects(); }, 15000);
      } else {
        try { clearInterval(specInterval) } catch(e) { }
      }
    });


  });
</script>